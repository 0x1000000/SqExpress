@page "/"
@using Microsoft.JSInterop
@using SqExpress.SqlTranspiler
@implements IAsyncDisposable
@inject IJSRuntime JsRuntime

<PageTitle>T-SQL to SqExpress C# Transpiler</PageTitle>

<section class="workspace">
    <header class="workspace-header">
        <div class="workspace-title-row">
            <h1>T-SQL to SqExpress C# Transpiler</h1>
            <a class="github-link" href="https://github.com/0x1000000/SqExpress" target="_blank" rel="noopener noreferrer">GitHub Project</a>
        </div>
        <p>
            Accepts T-SQL statements with SELECT, nested subqueries, CTE, INSERT, UPDATE, DELETE, and MERGE,
            including variables like <code>&#64;name</code> and list variables for <code>IN (&#64;items)</code>.
        </p>
    </header>

    <div class="editor-card">
        <div class="card-title-row">
            <h2>SQL Input</h2>
            <div class="editor-actions">
                <button class="action-button action-button-secondary" @onclick="FormatSqlAsync">Format SQL</button>
                <button class="action-button" @onclick="TranspileAsync">Transpile</button>
            </div>
        </div>
        <div id="sql-editor" class="sql-editor"></div>
    </div>

    <div class="settings-card">
        <div class="settings-grid">
            <label class="setting-item">
                <span class="setting-label">
                    Table descriptor prefix
                    <span class="setting-hint" title="Prepends this text to generated table descriptor class names. Example: prefix 'Table' + 'Users' => 'TableUsers'.">?</span>
                </span>
                <input type="text" value="@this._tableDescriptorPrefix" @oninput="this.OnTableDescriptorPrefixInputAsync" />
            </label>
            <label class="setting-item">
                <span class="setting-label">
                    Table descriptor suffix
                    <span class="setting-hint" title="Appends this text to generated table descriptor class names. Example: 'Users' + suffix 'Tbl' => 'UsersTbl'.">?</span>
                </span>
                <input type="text" value="@this._tableDescriptorSuffix" @oninput="this.OnTableDescriptorSuffixInputAsync" />
            </label>
            <label class="setting-item">
                <span class="setting-label">
                    Default schema
                    <span class="setting-hint" title="Schema used for unqualified table names (for example 'Users'). Default is 'dbo'. Leave empty to disable implicit schema.">?</span>
                </span>
                <input type="text" value="@this._defaultSchemaName" @oninput="this.OnDefaultSchemaInputAsync" />
            </label>
            <label class="setting-item setting-item-checkbox">
                <span class="setting-label">
                    Use static SqQueryBuilder
                    <span class="setting-hint" title="When enabled, generated code uses 'using static SqExpress.SqQueryBuilder;'. When disabled, generated calls are explicit as 'SqQueryBuilder.Select(...)'.">?</span>
                </span>
                <div class="checkbox-input-row">
                    <input type="checkbox" checked="@this._useStaticSqQueryBuilderUsing" @onchange="this.OnUseStaticSqQueryBuilderUsingChangedAsync" />
                    <span class="checkbox-state" aria-hidden="true"></span>
                </div>
            </label>
        </div>
    </div>

    @if (!string.IsNullOrWhiteSpace(this._error))
    {
        <div class="error-box">@this._error</div>
    }

    <div class="note-box">
        Note: column types usually cannot be determined reliably from SQL text alone. The transpiler uses best-effort inference.
        For accurate table descriptors, use the scaffolding/codegen tool included in SqExpress.
    </div>

    <div class="outputs-grid">
        <div class="output-card">
            <h2>SqQuery Output</h2>
            <div id="query-output-editor" class="csharp-output-editor"></div>
        </div>
        <div class="output-card">
            <h2>Declarations Output</h2>
            <div id="declarations-output-editor" class="csharp-output-editor"></div>
        </div>
    </div>
</section>

@code
{
    private const string EditorElementId = "sql-editor";
    private const string QueryOutputElementId = "query-output-editor";
    private const string DeclarationsOutputElementId = "declarations-output-editor";
    private const string PrefixStorageKey = "sqexpress.transpiler.tablePrefix";
    private const string SuffixStorageKey = "sqexpress.transpiler.tableSuffix";
    private const string DefaultSchemaStorageKey = "sqexpress.transpiler.defaultSchema";
    private const string UseStaticSqQueryBuilderUsingStorageKey = "sqexpress.transpiler.useStaticSqQueryBuilderUsing";
    private DotNetObjectReference<Home>? _dotNetRef;
    private string _sqlText =
        "SELECT u.UserId, u.Name AS UserName " +
        "FROM dbo.Users u " +
        "WHERE u.IsActive = 1 " +
        "ORDER BY u.Name DESC";
    private string _tableDescriptorPrefix = "Table";
    private string _tableDescriptorSuffix = string.Empty;
    private string _defaultSchemaName = "dbo";
    private bool _useStaticSqQueryBuilderUsing = true;

    private string _queryOutput = string.Empty;
    private string _declarationsOutput = string.Empty;
    private string? _error;
    private bool _editorInitialized;
    private bool _outputEditorsInitialized;

    [JSInvokable]
    public Task OnSqlChangedFromJs(string sqlText)
    {
        this._sqlText = sqlText;
        return Task.CompletedTask;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
        {
            return;
        }

        this._dotNetRef = DotNetObjectReference.Create(this);
        await this.LoadUiSettingsAsync();
        this.StateHasChanged();
        await JsRuntime.InvokeVoidAsync("sqExpressSqlEditor.initialize", EditorElementId, this._dotNetRef, this._sqlText);
        this._editorInitialized = true;
        await JsRuntime.InvokeVoidAsync("sqExpressCodeOutput.initialize", QueryOutputElementId, this._queryOutput);
        await JsRuntime.InvokeVoidAsync("sqExpressCodeOutput.initialize", DeclarationsOutputElementId, this._declarationsOutput);
        this._outputEditorsInitialized = true;
        await this.TranspileAsync();
    }

    private async Task TranspileAsync()
    {
        try
        {
            if (this._editorInitialized)
            {
                this._sqlText = await JsRuntime.InvokeAsync<string>("sqExpressSqlEditor.getValue", EditorElementId);
            }

            var transpiler = new SqExpressSqlTranspiler();
            var options = new SqExpressSqlTranspilerOptions
            {
                TableDescriptorClassPrefix = this._tableDescriptorPrefix,
                TableDescriptorClassSuffix = this._tableDescriptorSuffix,
                DefaultSchemaName = this._defaultSchemaName,
                UseStaticSqQueryBuilderUsing = this._useStaticSqQueryBuilderUsing
            };
            var result = transpiler.Transpile(this._sqlText, options);

            this._queryOutput = result.QueryCSharpCode;
            this._declarationsOutput = result.DeclarationsCSharpCode;
            this._error = null;
        }
        catch (Exception ex)
        {
            this._queryOutput = string.Empty;
            this._declarationsOutput = string.Empty;
            this._error = ex.Message;
        }

        if (this._outputEditorsInitialized)
        {
            await JsRuntime.InvokeVoidAsync("sqExpressCodeOutput.setValue", QueryOutputElementId, this._queryOutput);
            await JsRuntime.InvokeVoidAsync("sqExpressCodeOutput.setValue", DeclarationsOutputElementId, this._declarationsOutput);
        }
    }

    private async Task FormatSqlAsync()
    {
        try
        {
            if (this._editorInitialized)
            {
                this._sqlText = await JsRuntime.InvokeAsync<string>("sqExpressSqlEditor.getValue", EditorElementId);
            }

            var formatter = new SqExpressSqlFormatter();
            this._sqlText = formatter.Format(this._sqlText);
            this._error = null;

            if (this._editorInitialized)
            {
                await JsRuntime.InvokeVoidAsync("sqExpressSqlEditor.setValue", EditorElementId, this._sqlText);
            }
        }
        catch (Exception ex)
        {
            this._error = ex.Message;
        }
    }

    private async Task OnTableDescriptorPrefixInputAsync(ChangeEventArgs args)
    {
        this._tableDescriptorPrefix = args.Value?.ToString() ?? string.Empty;
        await this.PersistUiSettingsAsync();
    }

    private async Task OnTableDescriptorSuffixInputAsync(ChangeEventArgs args)
    {
        this._tableDescriptorSuffix = args.Value?.ToString() ?? string.Empty;
        await this.PersistUiSettingsAsync();
    }

    private async Task OnDefaultSchemaInputAsync(ChangeEventArgs args)
    {
        this._defaultSchemaName = args.Value?.ToString() ?? string.Empty;
        await this.PersistUiSettingsAsync();
    }

    private async Task OnUseStaticSqQueryBuilderUsingChangedAsync(ChangeEventArgs args)
    {
        this._useStaticSqQueryBuilderUsing = args.Value is bool flag && flag;
        await this.PersistUiSettingsAsync();
    }

    private async Task LoadUiSettingsAsync()
    {
        this._tableDescriptorPrefix = await this.GetStoredSettingAsync(PrefixStorageKey, this._tableDescriptorPrefix);
        this._tableDescriptorSuffix = await this.GetStoredSettingAsync(SuffixStorageKey, this._tableDescriptorSuffix);
        this._defaultSchemaName = await this.GetStoredSettingAsync(DefaultSchemaStorageKey, this._defaultSchemaName);
        this._useStaticSqQueryBuilderUsing =
            await this.GetStoredBoolSettingAsync(UseStaticSqQueryBuilderUsingStorageKey, this._useStaticSqQueryBuilderUsing);
    }

    private async Task PersistUiSettingsAsync()
    {
        await this.SetStoredSettingAsync(PrefixStorageKey, this._tableDescriptorPrefix);
        await this.SetStoredSettingAsync(SuffixStorageKey, this._tableDescriptorSuffix);
        await this.SetStoredSettingAsync(DefaultSchemaStorageKey, this._defaultSchemaName);
        await this.SetStoredSettingAsync(
            UseStaticSqQueryBuilderUsingStorageKey,
            this._useStaticSqQueryBuilderUsing ? "true" : "false");
    }

    private async Task<bool> GetStoredBoolSettingAsync(string key, bool fallback)
    {
        var text = await this.GetStoredSettingAsync(key, fallback ? "true" : "false");
        return string.Equals(text, "true", StringComparison.OrdinalIgnoreCase);
    }

    private async Task<string> GetStoredSettingAsync(string key, string fallback)
    {
        try
        {
            var value = await JsRuntime.InvokeAsync<string?>("sqExpressSettingsStore.get", key);
            return value ?? fallback;
        }
        catch
        {
            return fallback;
        }
    }

    private async Task SetStoredSettingAsync(string key, string value)
    {
        try
        {
            await JsRuntime.InvokeVoidAsync("sqExpressSettingsStore.set", key, value);
        }
        catch
        {
            // Ignore storage errors and keep transpiler usable.
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (this._editorInitialized)
        {
            await JsRuntime.InvokeVoidAsync("sqExpressSqlEditor.dispose", EditorElementId);
        }

        if (this._outputEditorsInitialized)
        {
            await JsRuntime.InvokeVoidAsync("sqExpressCodeOutput.dispose", QueryOutputElementId);
            await JsRuntime.InvokeVoidAsync("sqExpressCodeOutput.dispose", DeclarationsOutputElementId);
        }

        this._dotNetRef?.Dispose();
    }
}
