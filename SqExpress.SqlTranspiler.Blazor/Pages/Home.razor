@page "/"
@using Microsoft.JSInterop
@using SqExpress.SqlTranspiler
@implements IAsyncDisposable
@inject IJSRuntime JsRuntime

<PageTitle>T-SQL to SqExpress C# Transpiler</PageTitle>

<section class="workspace">
    <header class="workspace-header">
        <div class="workspace-title-row">
            <h1>T-SQL to SqExpress C# Transpiler</h1>
            <a class="github-link" href="https://github.com/0x1000000/SqExpress" target="_blank" rel="noopener noreferrer">GitHub Project</a>
        </div>
        <p>
            Accepts T-SQL statements with SELECT, nested subqueries, CTE, INSERT, UPDATE, DELETE, and MERGE,
            including variables like <code>&#64;name</code> and list variables for <code>IN (&#64;items)</code>.
        </p>
    </header>

    <div class="editor-card">
        <div class="card-title-row">
            <h2>SQL Input</h2>
            <button class="action-button" @onclick="TranspileAsync">Transpile</button>
        </div>
        <div id="sql-editor" class="sql-editor"></div>
    </div>

    @if (!string.IsNullOrWhiteSpace(this._error))
    {
        <div class="error-box">@this._error</div>
    }

    <div class="note-box">
        Note: column types usually cannot be determined reliably from SQL text alone. The transpiler uses best-effort inference.
        For accurate table descriptors, use the scaffolding/codegen tool included in SqExpress.
    </div>

    <div class="outputs-grid">
        <div class="output-card">
            <h2>SqQuery Output</h2>
            <div id="query-output-editor" class="csharp-output-editor"></div>
        </div>
        <div class="output-card">
            <h2>Declarations Output</h2>
            <div id="declarations-output-editor" class="csharp-output-editor"></div>
        </div>
    </div>
</section>

@code
{
    private const string EditorElementId = "sql-editor";
    private const string QueryOutputElementId = "query-output-editor";
    private const string DeclarationsOutputElementId = "declarations-output-editor";
    private DotNetObjectReference<Home>? _dotNetRef;
    private string _sqlText =
        "SELECT u.UserId, u.Name AS UserName " +
        "FROM dbo.Users u " +
        "WHERE u.IsActive = 1 " +
        "ORDER BY u.Name DESC";

    private string _queryOutput = string.Empty;
    private string _declarationsOutput = string.Empty;
    private string? _error;
    private bool _editorInitialized;
    private bool _outputEditorsInitialized;

    [JSInvokable]
    public Task OnSqlChangedFromJs(string sqlText)
    {
        this._sqlText = sqlText;
        return Task.CompletedTask;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
        {
            return;
        }

        this._dotNetRef = DotNetObjectReference.Create(this);
        await JsRuntime.InvokeVoidAsync("sqExpressSqlEditor.initialize", EditorElementId, this._dotNetRef, this._sqlText);
        this._editorInitialized = true;
        await JsRuntime.InvokeVoidAsync("sqExpressCodeOutput.initialize", QueryOutputElementId, this._queryOutput);
        await JsRuntime.InvokeVoidAsync("sqExpressCodeOutput.initialize", DeclarationsOutputElementId, this._declarationsOutput);
        this._outputEditorsInitialized = true;
        await this.TranspileAsync();
    }

    private async Task TranspileAsync()
    {
        try
        {
            if (this._editorInitialized)
            {
                this._sqlText = await JsRuntime.InvokeAsync<string>("sqExpressSqlEditor.getValue", EditorElementId);
            }

            var transpiler = new SqExpressSqlTranspiler();
            var result = transpiler.Transpile(this._sqlText);

            this._queryOutput = result.QueryCSharpCode;
            this._declarationsOutput = result.DeclarationsCSharpCode;
            this._error = null;
        }
        catch (Exception ex)
        {
            this._queryOutput = string.Empty;
            this._declarationsOutput = string.Empty;
            this._error = ex.Message;
        }

        if (this._outputEditorsInitialized)
        {
            await JsRuntime.InvokeVoidAsync("sqExpressCodeOutput.setValue", QueryOutputElementId, this._queryOutput);
            await JsRuntime.InvokeVoidAsync("sqExpressCodeOutput.setValue", DeclarationsOutputElementId, this._declarationsOutput);
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (this._editorInitialized)
        {
            await JsRuntime.InvokeVoidAsync("sqExpressSqlEditor.dispose", EditorElementId);
        }

        if (this._outputEditorsInitialized)
        {
            await JsRuntime.InvokeVoidAsync("sqExpressCodeOutput.dispose", QueryOutputElementId);
            await JsRuntime.InvokeVoidAsync("sqExpressCodeOutput.dispose", DeclarationsOutputElementId);
        }

        this._dotNetRef?.Dispose();
    }
}
